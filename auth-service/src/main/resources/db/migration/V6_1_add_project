ALTER TABLE user_repo.roles ADD project_id int8 NOT NULL;
ALTER TABLE user_repo.users ADD project_id int8 NOT NULL;

-- user_repo.project definition

-- Drop table

-- DROP TABLE user_repo.project;

CREATE TABLE user_repo.project (
	id int8 NOT NULL GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE),
	code varchar(255) NULL,
	"name" varchar(255) NULL,
	CONSTRAINT project_pkey PRIMARY KEY (id),
	CONSTRAINT project_code UNIQUE (code)
);

-- user_repo.user_projects definition

-- Drop table

-- DROP TABLE user_repo.user_projects;

CREATE TABLE user_repo.user_projects (
	user_id int8 NOT NULL,
	project_id int8 NOT NULL
);


-- user_repo.user_projects foreign keys

ALTER TABLE user_repo.user_projects ADD CONSTRAINT key_user_project-project_id FOREIGN KEY (project_id) REFERENCES user_repo.project(id);
ALTER TABLE user_repo.user_projects ADD CONSTRAINT key_user_project-user_id FOREIGN KEY (user_id) REFERENCES user_repo.users(id);

INSERT INTO user_repo.project
("code","name")
SELECT
'DEVBO','Разработка TH'
WHERE NOT EXISTS (
    SELECT 1 FROM user_repo.project WHERE "code" = 'DEVBO');

UPDATE user_repo.project
SET id = 1
WHERE "name" = 'DEVBO';

UPDATE user_repo.roles 
SET project_id = 1
WHERE true ;

UPDATE user_repo.users
SET project_id = 1
WHERE true ;

INSERT INTO user_repo.user_projects (user_id, project_id)
SELECT id, 1 FROM user_repo.users WHERE true;
